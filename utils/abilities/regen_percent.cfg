#textdomain wesnoth-A_New_World

# ANW_LEADER_REGEN_PERCENT SIDES PERCENT
# Example: {ANW_LEADER_REGEN_PERCENT 2,3,4,5,6 10}
#
# Shows a visible ability "Regenerates +PERCENT%" on leaders of SIDES.
# Cures poison each turn and heals floor(max_hp * PERCENT / 100) at start of their side's turn.
# MP-safe (uses only synced events).
#define ANW_LEADER_REGEN_PERCENT SIDES PERCENT

    # Attach the visible ability (and a hidden helper to cure poison) at start.
    [event]
        name=start
        first_time_only=yes
        [modify_unit]
            [filter]
                side={SIDES}
                canrecruit=yes
            [/filter]
            [object]
                id=ANW_REGEN_PCT_OBJECT
                silent=yes
                duration=forever
                [effect]
                    apply_to=new_ability
                    [abilities]
                        # Visible label in UI
                        [dummy]
                            id=ANW_REGEN_PCT
                            name= _ "Regenerates +{PERCENT}%"
                            description= _ "Restores {PERCENT}% of its maximum HP at the start of its side’s turn and cures poison."
                        [/dummy]
                        # Hidden engine helper: cures poison automatically
                        [regenerate]
                            id=ANW_REGEN_PCT_ENGINE
                            value=0
                            poison=cured
                        [/regenerate]
                    [/abilities]
                [/effect]
            [/object]
        [/modify_unit]
    [/event]

    # On each listed side's turn, reattach ability if leader changed; then heal % and clear poison.
    [event]
        name=side turn
        first_time_only=no
        [filter_side]
            side={SIDES}
        [/filter_side]

        # Ensure current leader has the ability object.
        [modify_unit]
            [filter]
                side=$side_number
                canrecruit=yes
                [not]
                    [filter_wml]
                        [modifications]
                            [object]
                                id=ANW_REGEN_PCT_OBJECT
                            [/object]
                        [/modifications]
                    [/filter_wml]
                [/not]
            [/filter]
            [object]
                id=ANW_REGEN_PCT_OBJECT
                silent=yes
                duration=forever
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=ANW_REGEN_PCT
                            name= _ "Regenerates +{PERCENT}%"
                            description= _ "Restores {PERCENT}% of its maximum HP at the start of its side’s turn and cures poison."
                        [/dummy]
                        [regenerate]
                            id=ANW_REGEN_PCT_ENGINE
                            value=0
                            poison=cured
                        [/regenerate]
                    [/abilities]
                [/effect]
            [/object]
        [/modify_unit]

        # Heal PERCENT% of max HP and explicitly clear poison (belt & suspenders).
        [store_unit]
            variable=anw_regen_targets
            [filter]
                side=$side_number
                canrecruit=yes
                # Has our visible ability (not strictly required, but nice for clarity)
                ability=ANW_REGEN_PCT
            [/filter]
        [/store_unit]

        [foreach]
            array=anw_regen_targets
            [do]
                [set_variable]
                    name=anw_heal_amt
                    value=$this_item.max_hitpoints
                [/set_variable]
                [set_variable]
                    name=anw_heal_amt
                    multiply={PERCENT}
                [/set_variable]
                [set_variable]
                    name=anw_heal_amt
                    divide=100
                [/set_variable]

                [modify_unit]
                    [filter]
                        id=$this_item.id
                    [/filter]
                    [status]
                        poisoned=no
                    [/status]
                [/modify_unit]

                [heal_unit]
                    [filter]
                        id=$this_item.id
                    [/filter]
                    amount=$anw_heal_amt
                [/heal_unit]
            [/do]
        [/foreach]

        {CLEAR_VARIABLE anw_regen_targets}
        {CLEAR_VARIABLE anw_heal_amt}
    [/event]
#enddef
